import pandas as pd
import numpy as np
from pathlib import Path

### TO BE UPDATED ###
class Vulnerability:
    def __init__(self, datadir):
        self.datadir = datadir

    def get_vulnerability_function(self):
        # TODO: @Luis: this function needs to be changed. Now it looks up a damage function
        # according to country that is chosen but we want the user to choose their
        # damage functions per category (res, com, etc.). So our function will be
        # quite different.
        """Return the susceptibility function id and the maximum damage number."""

        # Read the global exposure configuration.
        df_config = pd.read_excel(
            Path(self.datadir).joinpath("AllDDF.xlsx"),
            sheet_name="flBldgStructDmgFn"
        )

        # Get vulnerability factors and apply FIAT format.
        vf_values = df_config.loc[1:2].values.T
        vf_values_only = vf_values[4:-1] / 100
        
        vf_water_depths_numbers = np.arange(-4,25)
        vf_water_depths = np.array(vf_water_depths_numbers.reshape(-1,1))
        vf_raw = np.hstack([vf_water_depths,vf_values_only])
        
        vf_names = np.array([['water depth','User Selected Vulnerability 1','User Selected Vulnerability 2']])
        vf_with_headers = np.concatenate([vf_names, vf_raw])
        
        top_header_array = np.full((1, 3), fill_value="", dtype='<U100')
        top_header_array[0, 0] = "UNIT=feet"

        vf_fiat_format = np.concatenate([top_header_array, vf_with_headers])

        # Create a dataframe out of the previous array.
        v_dataframe = pd.DataFrame(vf_fiat_format)
        
        # Export the dataframe to a csv.
        v_dataframe.to_csv('vulnerability_test_file_output.csv', index=False, header=False)
        