from hydromt_fiat.fiat import FiatModel
from hydromt.log import setuplog
from pathlib import Path
import pytest
import shutil
import geopandas as gpd


EXAMPLEDIR = Path().absolute() / "local_test_database"
DATADIR = Path().absolute() / "hydromt_fiat" / "data"

_cases = {
    "vulnerability_and_exposure": {
        "data_catalogue": DATADIR / "hydromt_fiat_catalog_USA.yml",
        "dir": "test_vulnerability_and_exposure",
    },
}


@pytest.mark.parametrize("case", list(_cases.keys()))
def test_vulnerability_exposure(case):
    # Read model in examples folder.
    root = EXAMPLEDIR.joinpath(_cases[case]["dir"])
    if root.exists():
        shutil.rmtree(root)
    data_catalog_yml = str(_cases[case]["data_catalogue"])

    configuration = {
        "setup_vulnerability": {
            "vulnerability_fn": "hazus_vulnerability_curves",
            "vulnerability_identifiers_and_linking_fn": ".\\examples\\data\\vulnerability_test_file_input.csv",
            "unit": "feet",
        },
        "setup_exposure_vector": {
            "asset_locations": "NSI",
            "occupancy_type": "NSI",
            "max_potential_damage": "NSI",
            "ground_floor_height": 1,
            "ground_floor_height_unit": "m",
        },
    }

    region = {
        "type": "FeatureCollection",
        "features": [
            {
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "coordinates": [
                        [
                            [-80.21997289327112, 25.83897611793664],
                            [-80.21997289327112, 25.86427542636784],
                            [-80.24609330530801, 25.86427542636784],
                            [-80.24609330530801, 25.83897611793664],
                            [-80.21997289327112, 25.83897611793664],
                        ]
                    ],
                    "type": "Polygon",
                },
            }
        ],
    }

    logger = setuplog("hydromt_fiat", log_level=10)

    fm = FiatModel(root=root, mode="w", data_libs=[data_catalog_yml], logger=logger)

    region = gpd.GeoDataFrame.from_features(region)
    fm.build(region={"geom": region}, opt=configuration)
    fm.write()
