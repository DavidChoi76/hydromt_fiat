from hydromt_fiat.fiat import FiatModel
from hydromt.log import setuplog
from pathlib import Path
import pytest
import shutil

EXAMPLEDIR = Path().absolute() / "local_test_database"

_cases = {
    "vulnerability": {
        "data_catalogue": EXAMPLEDIR / "fiat_catalog.yml",
        "dir": "test_vulnerability",
        "ini": EXAMPLEDIR / "test_vulnerability.ini",
    },
}


@pytest.mark.parametrize("case", list(_cases.keys()))
def test_vulnerability(case):
    # Read model in examples folder.
    root = EXAMPLEDIR.joinpath(_cases[case]["dir"])
    if root.exists():
        shutil.rmtree(root)

    configuration = {
        "setup_vulnerability": {
            "vulnerability_fn": "hazus_vulnerability_curves",
            "vulnerability_identifiers_and_linking_fn": ".\\examples\\data\\vulnerability_test_file_input.csv",
            "unit": "feet",
        }
    }

    data_catalog_yml = str(_cases[case]["data_catalogue"])
    logger = setuplog("hydromt_fiat", log_level=10)

    fm = FiatModel(root=root, mode="w", data_libs=[data_catalog_yml], logger=logger)

    fm.build(opt=configuration)
